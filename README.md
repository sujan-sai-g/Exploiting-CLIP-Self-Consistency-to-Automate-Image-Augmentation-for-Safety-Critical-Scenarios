# Exploiting-CLIP-Self-Consistency-to-Automate-Image-Augmentation-for-Safety-Critical-Scenarios

code for paper - Exploiting CLIP Self-Consistency to Automate Image Augmentation for Safety Critical Scenarios

This code is built on top of https://github.com/AUTOMATIC1111/stable-diffusion-webui v1.7.0

1. Setup conda enviroment

2. Please setup https://github.com/AUTOMATIC1111/stable-diffusion-webui 
 at v1.7.0 and follow installation instructions

3. Launch webui.sh

4. In extensions of the webui, install sd-webui-controlnet, sd-webui-segment-anything

5. Installation following additional libraries

    pip install groundingdino-py
	pip install segment-anything
	pip install -U git+https://github.com/luca-medeiros/lang-segment-anything.git

6. Copy the following files into the folders:
    modules/cmd_args.py
    scripts/data_generation_utils.py
    data_generator.py 


# Download following weights
## Diffusion models

- sd-v1-5-inpainting.ckpt (download from https://huggingface.co/runwayml/stable-diffusion-inpainting/blob/main/sd-v1-5-inpainting.ckpt)
- Deliberate_v5-inpainting.safetensors (download from https://huggingface.co/XpucT/Deliberate/tree/main)
- Reliberate_v2-inpainting.safetensors (download from https://huggingface.co/XpucT/Deliberate/tree/main)

## ControlNet
- https://huggingface.co/lllyasviel/ControlNet-v1-1/tree/main (download from https://huggingface.co/lllyasviel/ControlNet-v1-1/tree/main)

## Openpose images 
- Any website that provides openpose images - (e.g., https://civitai.com/models/56307/character-walking-and-running-animation-poses-8-directions)
For better quality, crop the pose part and remove the background before fitting to mask



# Genereate augmented images for cityscapes test set
```
python data_generator.py --batch_size=1 --diffusion_model_path /path-to-folder/sd-v1-5-inpainting.ckpt --input_image_path /path-to-cityscapes-images-in-single-folder/ --output_image_path /output-path-to-images/ --output_mask_positions /path-to-mask-folder/ --controlnet_name control_v11p_sd15_openpose.pth --openpose_path /path-to-openpose-images/
```

The prompts for generation (specifications) are provided in def get_prompt() in data_generation_utils.py


# Run self consistency
```
python self_consistency_check/run_self_consistency.py
```

This will create a lot of intermediate csvs and the finally show the list of consistent images. Current csvs are provided in the csv_outputs